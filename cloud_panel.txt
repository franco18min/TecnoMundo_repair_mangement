TecnoApp - Sistema de Gesti√≥n de √ìrdenes de Reparaci√≥n
üìã √çndice
Arquitectura General

Estructura del Servidor

Base de Datos

Backend (API)

Frontend (React)

Despliegue

Comandos √ötiles

Soluci√≥n de Problemas

üèóÔ∏è Arquitectura General
Stack Tecnol√≥gico
Frontend: React + Vite

Backend: FastAPI (Python 3.12)

Base de Datos: PostgreSQL 18

Servidor Web: NGINX (CloudPanel)

Hosting: DonWeb VPS Ubuntu 24.04

Control Panel: CloudPanel

Dominios
Frontend: https://tecnoapp.ar

Backend API: https://api.tecnoapp.ar

Panel CloudPanel: https://tecnoapp.site

Repositorio
GitHub: https://github.com/franco18min/TecnoMundo_repair_mangement

üìÅ Estructura del Servidor
Backend (API)
text
/home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/
‚îú‚îÄ‚îÄ .git/                    # Repositorio Git activo
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/            # Endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/           # Configuraci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ crud/           # Operaciones DB
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/         # Modelos SQLAlchemy
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/        # Schemas Pydantic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/       # Servicios (email, etc.)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db/             # Conexi√≥n DB
‚îÇ   ‚îú‚îÄ‚îÄ scripts/            # Scripts de migraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ venv/               # Entorno virtual Python
‚îÇ   ‚îú‚îÄ‚îÄ main.py             # Archivo principal
‚îÇ   ‚îú‚îÄ‚îÄ start.sh            # Script de inicio
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt    # Dependencias
‚îÇ   ‚îî‚îÄ‚îÄ .env                # Variables de entorno
‚îî‚îÄ‚îÄ frontend/               # Existe pero no se usa aqu√≠
Frontend (Archivos Est√°ticos)
text
/home/tecnoapp/htdocs/tecnoapp.ar/
‚îú‚îÄ‚îÄ index.html              # Punto de entrada
‚îú‚îÄ‚îÄ assets/                 # JS, CSS compilados
‚îÇ   ‚îú‚îÄ‚îÄ index-[hash].js
‚îÇ   ‚îî‚îÄ‚îÄ index-[hash].css
‚îú‚îÄ‚îÄ favicon.ico
‚îî‚îÄ‚îÄ [otros archivos est√°ticos]

Nota: Esta carpeta NO es un repositorio Git.
Solo contiene archivos compilados (dist/) del build de React.
Scripts de Gesti√≥n
text
/home/apitecnoapp/
‚îú‚îÄ‚îÄ deploy-full.sh          # Despliegue completo (backend + frontend)
‚îî‚îÄ‚îÄ status.sh               # Ver estado de la aplicaci√≥n
üóÑÔ∏è Base de Datos
PostgreSQL Local
Host: localhost

Puerto: 5433 (PostgreSQL 18)

Base de datos: tecnodb

Usuario: tecnodb

Contrase√±a: Tecnodb123*

Clusters PostgreSQL
text
Ver Cluster Port Status Owner    Data directory
16  main    5432 down   postgres /var/lib/postgresql/16/main
18  main    5433 online postgres /var/lib/postgresql/18/main
Schemas
customer: Datos de clientes y √≥rdenes

customer

device_type

device_condition

repair_order

repair_order_photo

status_order

predefined_checklist_item

system: Configuraci√≥n del sistema

user

roles

branch

notifications

system_config

ticket_config

photo

Conexi√≥n a la Base de Datos
text
# Conectarse a PostgreSQL local
psql -U tecnodb -d tecnodb -h localhost -p 5433

# Comandos √∫tiles dentro de psql:
\dn                  # Listar esquemas
\dt system.*         # Listar tablas del schema system
\dt customer.*       # Listar tablas del schema customer
\d tabla             # Ver estructura de una tabla
SELECT * FROM tabla; # Ver datos
\q                   # Salir
üîß Backend (API)
Ubicaci√≥n
text
/home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend
Configuraci√≥n (.env)
text
# Base de datos
DATABASE_URL="postgresql://tecnodb:Tecnodb123*@localhost:5433/tecnodb?sslmode=disable"
DB_HOST=localhost
DB_PORT=5433
DB_NAME=tecnodb
DB_USER=tecnodb
DB_PASSWORD=Tecnodb123*
DB_SSL=disable
DB_SSLMODE=disable
DB_DRIVER=pg8000

# Aplicaci√≥n
APP_PORT=9001
WORKERS=2

# CORS
ALLOWED_ORIGINS=https://tecnoapp.ar,https://www.tecnoapp.ar,http://localhost:5173,http://localhost:5174

# JWT
SECRET_KEY=tu-secret-key
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=240

# Email Transaccional (Env√≠aloSimple)
EMAIL_PROVIDER=envialosimple
EMAIL_API_BASE_URL=https://api.envialosimple.email/api/v1
EMAIL_API_KEY=tu-api-key
EMAIL_FROM=notificaciones@tecnoapp.ar
EMAIL_FROM_NAME=TecnoApp - Notificaciones
EMAIL_REPLY_TO=no-reply@tecnoapp.ar
CLIENT_PORTAL_BASE_URL=https://tecnoapp.ar
Inicio Manual
text
# Ir al directorio
cd /home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend

# Activar entorno virtual
source venv/bin/activate

# Iniciar aplicaci√≥n
./start.sh

# O en background:
nohup ./start.sh > /tmp/tecnoapp-backend.log 2>&1 &
Verificar Estado
text
# Ver procesos Python
ps aux | grep uvicorn

# Ver puerto 9001
netstat -tulpn | grep :9001

# Ver logs
tail -f /tmp/tecnoapp-backend.log

# Probar API
curl -I http://localhost:9001
curl -I https://api.tecnoapp.ar
Detener Backend
text
# Matar procesos uvicorn
pkill -f "uvicorn main:app"

# Verificar que se detuvo
ps aux | grep uvicorn
üé® Frontend (React)
Ubicaci√≥n de Archivos Compilados
text
/home/tecnoapp/htdocs/tecnoapp.ar/
Caracter√≠sticas
SPA (Single Page Application) con React Router

Archivos est√°ticos servidos por NGINX

NO es repositorio Git (solo archivos del build)

Configuraci√≥n NGINX (vHost)
text
server {
  server_name tecnoapp.ar www1.tecnoapp.ar;
  root /home/tecnoapp/htdocs/tecnoapp.ar;
  
  index index.html;

  # Fallback para SPA (React Router)
  location / {
    try_files $uri $uri/ /index.html;
  }

  # Cache de archivos est√°ticos
  location ~* \.(css|js|jpg|jpeg|gif|png|ico|svg|woff|woff2|ttf)$ {
    add_header Access-Control-Allow-Origin "*";
    expires max;
    access_log off;
  }
}
Importante: La regla try_files $uri $uri/ /index.html; es crucial para que React Router funcione al refrescar rutas como /login, /dashboard, etc.

üöÄ Despliegue
Script de Despliegue Completo
Ubicaci√≥n: /home/apitecnoapp/deploy-full.sh

Este script maneja:

Actualizaci√≥n del backend (git pull)

Recompilaci√≥n del frontend (clone ‚Üí build ‚Üí rsync)

Reinicio autom√°tico de servicios

Flujo de Trabajo
En Local (Desarrollo)
text
# 1. Clonar repositorio
git clone https://github.com/franco18min/TecnoMundo_repair_mangement.git
cd TecnoMundo_repair_mangement

# 2. Crear rama de desarrollo
git checkout -b desarrollo

# 3. Hacer cambios en backend/ o frontend/

# 4. Commit y push
git add .
git commit -m "feat: descripci√≥n del cambio"
git push origin desarrollo

# 5. Cuando est√© listo para producci√≥n
git checkout main
git merge desarrollo
git push origin main
En Servidor (Producci√≥n)
text
# Despliegue autom√°tico
/home/apitecnoapp/deploy-full.sh
Comandos de Despliegue
Despliegue Completo (Backend + Frontend)
text
/home/apitecnoapp/deploy-full.sh
Solo Backend
text
cd /home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend
pkill -f uvicorn
git pull origin main
source venv/bin/activate
pip install -r requirements.txt
nohup ./start.sh > /tmp/tecnoapp-backend.log 2>&1 &
Solo Frontend
text
# Crear directorio temporal
TEMP_DIR="/tmp/frontend-build-$(date +%s)"
git clone https://github.com/franco18min/TecnoMundo_repair_mangement.git $TEMP_DIR

# Compilar
cd $TEMP_DIR/frontend
npm ci
npm run build

# Desplegar
rsync -av --delete dist/ /home/tecnoapp/htdocs/tecnoapp.ar/

# Limpiar
rm -rf $TEMP_DIR
üõ†Ô∏è Comandos √ötiles
Gesti√≥n del Backend
text
# Ver estado
ps aux | grep uvicorn
netstat -tulpn | grep :9001

# Ver logs en tiempo real
tail -f /tmp/tecnoapp-backend.log

# Reiniciar
pkill -f uvicorn
cd /home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend
source venv/bin/activate
nohup ./start.sh > /tmp/tecnoapp-backend.log 2>&1 &

# Probar API
curl -I http://localhost:9001
curl -I https://api.tecnoapp.ar
Gesti√≥n de PostgreSQL
text
# Ver clusters
sudo pg_lsclusters

# Conectarse a la base de datos
psql -U tecnodb -d tecnodb -h localhost -p 5433

# Backup de la base de datos
pg_dump -Fc -U tecnodb -h localhost -p 5433 tecnodb > backup_$(date +%Y%m%d).dump

# Restaurar backup
pg_restore -v -d "postgresql://tecnodb:Tecnodb123*@localhost:5433/tecnodb" backup.dump

# Ver logs de PostgreSQL
journalctl -u postgresql -f
Verificaci√≥n del Sistema
text
# Estado general
/home/apitecnoapp/status.sh

# Servicios
systemctl status postgresql
systemctl status nginx

# Espacio en disco
df -h

# Memoria
free -h

# Procesos
htop
üî• Soluci√≥n de Problemas
Error 502 Bad Gateway
Causa: Backend no est√° corriendo

Soluci√≥n:

text
# Verificar si el backend est√° corriendo
ps aux | grep uvicorn

# Si no est√° corriendo, reiniciar
cd /home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend
source venv/bin/activate
nohup ./start.sh > /tmp/tecnoapp-backend.log 2>&1 &

# Ver logs para errores
tail -f /tmp/tecnoapp-backend.log
Error: Address Already in Use (Puerto 9001)
Causa: Ya hay un proceso usando el puerto

Soluci√≥n:

text
# Ver qu√© est√° usando el puerto
sudo lsof -i :9001

# Matar el proceso
pkill -f "uvicorn main:app"

# Reiniciar
cd /home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend
source venv/bin/activate
nohup ./start.sh > /tmp/tecnoapp-backend.log 2>&1 &
404 al Refrescar Rutas en el Frontend (/login, /dashboard)
Causa: Falta configuraci√≥n de fallback SPA en NGINX

Soluci√≥n: Agregar en vHost de tecnoapp.ar:

text
location / {
    try_files $uri $uri/ /index.html;
}
Error SSL al Conectar con PostgreSQL
Causa: SSL habilitado para conexi√≥n local

Soluci√≥n: En .env agregar:

text
DATABASE_URL="postgresql://tecnodb:Tecnodb123*@localhost:5433/tecnodb?sslmode=disable"
DB_SSL=disable
DB_SSLMODE=disable
PostgreSQL No Responde
Causa: Servicio no iniciado

Soluci√≥n:

text
# Ver clusters
sudo pg_lsclusters

# Si el cluster 18 est√° down
sudo pg_ctlcluster 18 main start

# Verificar
sudo netstat -tulpn | grep :5433
üì¶ Migraci√≥n desde Supabase
Credenciales Supabase (Solo para migraci√≥n)
text
Host: db.zshbhslyzclpovyngryf.supabase.co
Port: 5432
Database: postgres
User: postgres
Password: X8fJRji3Yd4PFCLI
Exportar Datos desde Supabase
text
# Exportar schemas completos
pg_dump -Fc -v --schema=system --schema=customer \
  "postgresql://postgres:X8fJRji3Yd4PFCLI@db.zshbhslyzclpovyngryf.supabase.co:5432/postgres" \
  > supabase_backup.dump

# Exportar tabla espec√≠fica
pg_dump -Fc -v --schema=customer --table=repair_order \
  "postgresql://postgres:X8fJRji3Yd4PFCLI@db.zshbhslyzclpovyngryf.supabase.co:5432/postgres" \
  > tabla_backup.dump
Importar a Base Local
text
# Restaurar backup completo
pg_restore -v -d "postgresql://tecnodb:Tecnodb123*@localhost:5433/tecnodb" supabase_backup.dump

# Restaurar tabla espec√≠fica
pg_restore -v -d "postgresql://tecnodb:Tecnodb123*@localhost:5433/tecnodb" tabla_backup.dump
Sincronizar Tabla Espec√≠fica con CSV
text
# 1. Exportar desde Supabase
psql "postgresql://postgres:X8fJRji3Yd4PFCLI@db.zshbhslyzclpovyngryf.supabase.co:5432/postgres" \
  -c "\copy system.photo TO '/tmp/photo_export.csv' CSV HEADER"

# 2. Limpiar tabla local
psql -U tecnodb -d tecnodb -h localhost -p 5433 -c "TRUNCATE TABLE system.photo CASCADE;"

# 3. Importar a local
psql -U tecnodb -d tecnodb -h localhost -p 5433 \
  -c "\copy system.photo FROM '/tmp/photo_export.csv' CSV HEADER"

# 4. Verificar
psql -U tecnodb -d tecnodb -h localhost -p 5433 -c "SELECT COUNT(*) FROM system.photo;"
üîÑ Script de Despliegue Completo
Contenido de /home/apitecnoapp/deploy-full.sh
text
#!/bin/bash
set -e

BACKEND_DIR="/home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend"
FRONTEND_TEMP_DIR="/tmp/frontend-build-$(date +%s)"
FRONTEND_DEST="/home/tecnoapp/htdocs/tecnoapp.ar"
REPO_URL="https://github.com/franco18min/TecnoMundo_repair_mangement.git"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "üöÄ ======== DESPLIEGUE COMPLETO TECNOAPP ========"

# === BACKEND ===
echo "üîß === DESPLEGANDO BACKEND ==="
pkill -f "uvicorn main:app" || true
sleep 3

cd $BACKEND_DIR
cp .env .env.backup.$TIMESTAMP
git pull origin main
source venv/bin/activate
pip install -r requirements.txt --quiet
cp .env.backup.$TIMESTAMP .env

nohup ./start.sh > /tmp/tecnoapp-backend.log 2>&1 &
sleep 5

if netstat -tulpn | grep -q :9001; then
    echo "‚úÖ Backend iniciado en puerto 9001"
else
    echo "‚ö†Ô∏è Backend no responde"
fi

# === FRONTEND ===
echo "üé® === DESPLEGANDO FRONTEND ==="
rm -rf $FRONTEND_TEMP_DIR
git clone $REPO_URL $FRONTEND_TEMP_DIR

cd $FRONTEND_TEMP_DIR/frontend
npm ci --silent

if [ -f ".env.production.example" ]; then
    cp .env.production.example .env.production
fi

npm run build
rsync -av --delete --progress dist/ $FRONTEND_DEST/
rm -rf $FRONTEND_TEMP_DIR

echo "üéâ ======== DESPLIEGUE COMPLETADO ========"
echo "üåê Backend: https://api.tecnoapp.ar"
echo "üåê Frontend: https://tecnoapp.ar"
Ejecuci√≥n
text
# Dar permisos (solo primera vez)
chmod +x /home/apitecnoapp/deploy-full.sh

# Ejecutar despliegue
/home/apitecnoapp/deploy-full.sh
üìä Comandos de Verificaci√≥n R√°pida
text
# Estado completo
echo "=== Backend ===" && ps aux | grep uvicorn | grep -v grep
echo "=== Puerto ===" && netstat -tulpn | grep :9001
echo "=== PostgreSQL ===" && sudo pg_lsclusters
echo "=== √öltimos logs ===" && tail -10 /tmp/tecnoapp-backend.log

# Test de conectividad
curl -I http://localhost:9001
curl -I https://api.tecnoapp.ar
curl -I https://tecnoapp.ar

# Base de datos
psql -U tecnodb -d tecnodb -h localhost -p 5433 -c "
SELECT 'customer.repair_order' as tabla, count(*) FROM customer.repair_order
UNION ALL
SELECT 'customer.customer', count(*) FROM customer.customer
UNION ALL
SELECT 'system.user', count(*) FROM system.user;
"
üîê Accesos y Credenciales
SSH
text
ssh root@vps-5412843-x.vps.donweb.com
PostgreSQL Local
text
psql -U tecnodb -d tecnodb -h localhost -p 5433
# Contrase√±a: Tecnodb123*
CloudPanel
URL: https://tecnoapp.site

Usuario: (seg√∫n configuraci√≥n)

üìù Notas Importantes
Backend es repositorio Git activo: Se actualiza con git pull

Frontend NO es repositorio Git: Se actualiza recompilando desde temporal

PostgreSQL corre en puerto 5433 (no el est√°ndar 5432)

Backend corre en puerto 9001 (NGINX hace proxy)

Usar nohup para mantener procesos corriendo despu√©s de cerrar SSH

Siempre hacer backup de .env antes de actualizar

üñ•Ô∏è Apartado: Acceso y Comandos en CloudPanel Hosting
Lista Esencial de Comandos de Conexi√≥n y Navegaci√≥n (cd /WINDOWS/system32)
1. Acceso SSH al Server CloudPanel
bash
# Conectarse por SSH usando root (o usuario con permisos sudo)
ssh root@vps-5412843-x.vps.donweb.com
# O si tienes otro usuario:
ssh apitecnoapp@vps-5412843-x.vps.donweb.com
2. Acceso a CloudPanel Web
URL: https://tecnoapp.site

Ingresar usuario y clave del CloudPanel

3. Navegaci√≥n por los Directorios Principales
Backend
bash
# Backend principal
cd /home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend
# Para ver archivos
ls -lh
# Para ver el script de inicio, entorno virtual y dependencias:
cat start.sh
cat requirements.txt
ls venv/
Frontend (Archivos Est√°ticos)
bash
# Frontend p√∫blico
cd /home/tecnoapp/htdocs/tecnoapp.ar
ls -lh
# Para ver el index y assets
cat index.html
ls assets/
Scripts de despliegue y estado
bash
# Script de despliegue completo
cd /home/apitecnoapp
ls -lh deploy-full.sh status.sh
cat deploy-full.sh
cat status.sh
4. Gesti√≥n de NGINX y CloudPanel
bash
# Ver configuraci√≥n de los vHosts
cd /etc/nginx/sites-enabled
ls
cat tecnoapp_ar.conf  # (nombres pueden variar, revisa la lista)
# Reiniciar NGINX
sudo systemctl restart nginx
# Ver logs de NGINX
sudo tail -f /var/log/nginx/error.log
5. PostgreSQL (Gesti√≥n Base de Datos)
bash
# Navegar a clusters de PostgreSQL
cd /var/lib/postgresql/
ls
# Ver versiones y clusters activos
sudo pg_lsclusters
# Conectarse a la base tecnodb
psql -U tecnodb -d tecnodb -h localhost -p 5433
üìÅ Principales Directorios en Cloud
Componente	Ruta principal
Backend	/home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend
Frontend	/home/tecnoapp/htdocs/tecnoapp.ar
Deploy	/home/apitecnoapp/deploy-full.sh
Estado	/home/apitecnoapp/status.sh
Config NGINX	/etc/nginx/sites-enabled/tecnoapp_ar.conf (o parecido)
PostgreSQL	/var/lib/postgresql/18/main (datos cluster 18)
Venv Python	/home/apitecnoapp/htdocs/api.tecnoapp.ar/TecnoMundo_repair_mangement/backend/venv


üÜò Contacto para Soporte
Repositorio: https://github.com/franco18min/TecnoMundo_repair_mangement

Issues: https://github.com/franco18min/TecnoMundo_repair_mangement/issues

üìö Documentacion de Soporte

* Website:         https://www.cloudpanel.io
* Documentation:   https://www.cloudpanel.io/docs/v2/
* Best Practices:  https://www.cloudpanel.io/docs/v2/best-practices/
* CloudPanel:      https://tecnoapp.site/ 
* CloudPanel CLI:  clpctl

üìÖ Historial de Cambios
2025-10-30: Migraci√≥n inicial desde Supabase a DonWeb

2025-10-31: Configuraci√≥n de despliegue autom√°tico

2025-11-01: Correcci√≥n de fallback SPA en NGINX

2025-11-05: Implementaci√≥n de sistema de emails autom√°ticos

2025-11-08: Migraci√≥n de tabla system.photo